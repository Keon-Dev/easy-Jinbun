<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<div class="container">
  <h1 class="mb-4">ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body text-center">
          <h3><%= courseCount %></h3>
          <p class="text-muted">ç™»éŒ²æˆæ¥­æ•°</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body text-center">
          <h3><%= reviewCount %></h3>
          <p class="text-muted">ç·ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°</p>
        </div>
      </div>
    </div>
  </div>
  
  <h2 class="mb-3">æœ€æ–°ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
  
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>æˆæ¥­å</th>
          <th>æ¥½å˜åº¦</th>
          <th>é¢ç™½ã•</th>
          <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
          <th>æŠ•ç¨¿æ—¥</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <% recentReviews.forEach(review => { %>
          <tr id="review-<%= review._id %>">
            <td>
              <% if (review.course_id) { %>
                <a href="/courses/<%= review.course_id._id %>"><%= review.course_id.title %></a>
              <% } else { %>
                (å‰Šé™¤æ¸ˆã¿)
              <% } %>
            </td>
            <td><%= review.ease_rating %> / 5</td>
            <td><%= review.fun_rating %> / 5</td>
            <td><%= review.comment ? review.comment.substring(0, 50) + (review.comment.length > 50 ? '...' : '') : '-' %></td>
            <td><%= new Date(review.created_at).toLocaleDateString('ja-JP') %></td>
            <td>
              <button class="btn btn-sm btn-danger delete-review-btn" data-review-id="<%= review._id %>">
                å‰Šé™¤
              </button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ğŸ”‘ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’JSå¤‰æ•°ã«æ ¼ç´
  const CSRF_TOKEN = "<%= csrfToken %>";
  // ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  document.querySelectorAll('.delete-review-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const reviewId = this.getAttribute('data-review-id');
      
      if (!confirm('ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      try {
        const response = await fetch(`/admin/reviews/${reviewId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': CSRF_TOKEN // <-- è¿½åŠ 
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // è¡Œã‚’å‰Šé™¤
          document.getElementById(`review-${reviewId}`).remove();
          alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        } else {
          alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
        }
      } catch (err) {
        console.error(err);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });
  });
</script>
</body>
</html>