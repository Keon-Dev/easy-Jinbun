<%- include('partials/header') %>
<%- include('partials/navbar') %>

<div class="container">
  <div class="row">
    <div class="col-md-7 col-lg-7">
      <!-- æˆæ¥­ã‚¿ã‚¤ãƒˆãƒ« -->
      <h1><%= course.title %></h1>
      <h4 class="text-muted mb-3"><%= course.professor %></h4>
      
      <% 
        let badgeClass = 'bg-secondary';
        if (course.category === 'äººæ–‡ç¤¾ä¼šç³»ç§‘ç›®') badgeClass = 'bg-primary';
        else if (course.category === 'ã‚°ãƒ­ãƒ¼ãƒãƒ«æ•™é¤Šç§‘ç›®') badgeClass = 'bg-success';
      %>
      <% if (course.category) { %>
        <span class="badge <%= badgeClass %> mb-3"><%= course.category %></span>
      <% } %>
      
      <!-- æˆæ¥­æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">æˆæ¥­æƒ…å ±</h5>
          
          <div class="row">
            <div class="col-md-6">
              <p><strong>å¯¾è±¡å­¦å¹´:</strong> 
                <% if (course.target_grade && Array.isArray(course.target_grade)) { %>
                  <%= course.target_grade.join(', ') %>
                <% } else { %>
                  <%= course.target_grade || 'æœªè¨­å®š' %>
                <% } %>
              </p>
              <p><strong>é–‹è¬›æ™‚æœŸ:</strong> <%= course.semester || 'æœªè¨­å®š' %></p>
              <p><strong>å˜ä½æ•°:</strong> <%= course.credits %>å˜ä½</p>
              <% if (course.credit_type) { %>
                <p><strong>å˜ä½åŒºåˆ†:</strong> <%= course.credit_type %></p>
              <% } %>
            </div>
            <div class="col-md-6">
              <% if (course.classroom) { %>
                <p><strong>è¬›ç¾©å®¤:</strong> <%= course.classroom %></p>
              <% } %>
              <% if (course.campus) { %>
                <p><strong>ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹:</strong> <%= course.campus %></p>
              <% } %>
              <% if (course.professor_email) { %>
                <p><strong>æ•™å“¡ãƒ¡ãƒ¼ãƒ«:</strong> <a href="mailto:<%= course.professor_email %>"><%= course.professor_email %></a></p>
              <% } %>
            </div>
          </div>
          
          <!-- ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰å‰²åˆ -->
          <% if (course.ondemand_count > 0 || course.attendance_count > 0) { %>
            <hr>
            <h6>æˆæ¥­å½¢å¼</h6>
            <div class="row">
              <div class="col-md-8">
                <div class="progress" style="height: 30px;">
                  <% 
                    const total = course.attendance_count + course.ondemand_count;
                    const attendancePercent = total === 0 ? 0 : (course.attendance_count / total * 100);
                    const ondemandPercent = total === 0 ? 0 : (course.ondemand_count / total * 100);
                  %>
                  <% if (course.attendance_count > 0) { %>
                    <div class="progress-bar bg-success" style="width: <%= attendancePercent %>%" data-bs-toggle="tooltip" title="å¯¾é¢: <%= course.attendance_count %>å› (<%= attendancePercent.toFixed(1) %>%)">
                      å¯¾é¢ <%= course.attendance_count %>å›
                    </div>
                  <% } %>
                  <% if (course.ondemand_count > 0) { %>
                    <div class="progress-bar bg-warning" style="width: <%= ondemandPercent %>%" data-bs-toggle="tooltip" title="ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰: <%= course.ondemand_count %>å› (<%= ondemandPercent.toFixed(1) %>%)">
                      ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ <%= course.ondemand_count %>å›
                    </div>
                  <% } %>
                </div>
              </div>
              <div class="col-md-4">
                <p class="mb-0"><strong>ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰å‰²åˆ:</strong> <%= course.ondemand_ratio.toFixed(2) %>%</p>
              </div>
            </div>
          <% } %>
          
          <!-- æˆç¸¾è©•ä¾¡å‰²åˆ -->
          <hr>
          <h6>æˆç¸¾è©•ä¾¡å‰²åˆ</h6>
          <div class="progress mb-3" style="height: 30px;">
            <% if (course.grading && course.grading.report > 0) { %>
              <div class="progress-bar bg-info" style="width: <%= course.grading.report %>%" data-bs-toggle="tooltip" data-bs-placement="top" title="ãƒ¬ãƒãƒ¼ãƒˆ: <%= course.grading.report %>%">
                <% if (course.grading.report >= 10) { %>ãƒ¬ãƒãƒ¼ãƒˆ <%= course.grading.report %>%<% } %>
              </div>
            <% } %>
            <% if (course.grading && course.grading.exam > 0) { %>
              <div class="progress-bar bg-danger" style="width: <%= course.grading.exam %>%" data-bs-toggle="tooltip" data-bs-placement="top" title="è©¦é¨“: <%= course.grading.exam %>%">
                <% if (course.grading.exam >= 10) { %>è©¦é¨“ <%= course.grading.exam %>%<% } %>
              </div>
            <% } %>
            <% if (course.grading && course.grading.outside_task > 0) { %>
              <div class="progress-bar bg-warning" style="width: <%= course.grading.outside_task %>%" data-bs-toggle="tooltip" data-bs-placement="top" title="æˆæ¥­å¤–èª²é¡Œ: <%= course.grading.outside_task %>%">
                <% if (course.grading.outside_task >= 10) { %>æˆæ¥­å¤– <%= course.grading.outside_task %>%<% } %>
              </div>
            <% } %>
            <% if (course.grading && course.grading.inside_task > 0) { %>
              <div class="progress-bar bg-success" style="width: <%= course.grading.inside_task %>%" data-bs-toggle="tooltip" data-bs-placement="top" title="æˆæ¥­ä¸­èª²é¡Œ: <%= course.grading.inside_task %>%">
                <% if (course.grading.inside_task >= 10) { %>æˆæ¥­ä¸­ <%= course.grading.inside_task %>%<% } %>
              </div>
            <% } %>
            <% if (course.grading && course.grading.project > 0) { %>
              <div class="progress-bar bg-primary" style="width: <%= course.grading.project %>%" data-bs-toggle="tooltip" data-bs-placement="top" title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ç™ºè¡¨: <%= course.grading.project %>%">
                <% if (course.grading.project >= 10) { %>ç™ºè¡¨ <%= course.grading.project %>%<% } %>
              </div>
            <% } %>
          </div>    
          <!-- æˆæ¥­èª¬æ˜ -->
          <% if (course.description) { %>
            <hr>
            <h6>æˆæ¥­èª¬æ˜</h6>
            <p style="white-space: pre-wrap;"><%= course.description %></p>
          <% } %>
          
          <div class="mt-3">
            <!-- ç·¨é›†ãƒœã‚¿ãƒ³: å…¨å“¡è¡¨ç¤º -->
            <a href="/courses/<%= course._id %>/edit" class="btn btn-warning">ç·¨é›†</a>
            <a href="/" class="btn btn-secondary">ä¸€è¦§ã«æˆ»ã‚‹</a>

            <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
              <!-- ç®¡ç†è€…ã®ã¿è¡¨ç¤º -->
              <button class="btn btn-danger" id="deleteCourseBtn" data-course-id="<%= course._id %>">
                æˆæ¥­ã‚’å‰Šé™¤
              </button>
            <% } %>
          </div>
        </div>
      </div>
      
      <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <h3>ãƒ¬ãƒ“ãƒ¥ãƒ¼ (<%= reviews.length %>ä»¶)</h3>
      
      <% if (reviews.length === 0) { %>
        <div class="alert alert-info">
          ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
        </div>
      <% } %>
      
      <% reviews.forEach(review => { %>
        <div class="card mb-3">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p class="mb-2"><strong>æ¥½å˜åº¦:</strong></p>
                <p class="starability-result" data-rating="<%= review.ease_rating %>"style="transform: scale(0.9);">
                  Rated: <%= review.ease_rating %> stars
                </p>
              </div>
              <div class="col-md-6">
                <p class="mb-2"><strong>é¢ç™½ã•:</strong></p>
                <p class="starability-result" data-rating="<%= review.fun_rating %>"style="transform: scale(0.9);">
                  Rated: <%= review.fun_rating %> stars
                </p>
              </div>
            </div>
            <% if (review.comment) { %>
              <hr>
              <p class="mt-2 mb-0" style="white-space: pre-wrap;"><%= review.comment %></p>
            <% } %>
            <hr>
            <small class="text-muted">ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿æ—¥: <%= new Date(review.created_at).toLocaleDateString('ja-JP') %></small>

            <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
              <!-- ç®¡ç†è€…ã®ã¿è¡¨ç¤º -->
              <button class="btn btn-sm btn-danger delete-review-btn" data-review-id="<%= review._id %>">
                å‰Šé™¤
              </button>
            <% } %>
          </div>
        </div>
      <% }) %>
    </div>
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆçµ±è¨ˆæƒ…å ±ï¼‰ -->
    <div class="col-md-5 col-lg-5">
      <div class="card" style="top: 20px;">
        <div class="card-body">
          <h5 class="card-title">çµ±è¨ˆæƒ…å ±</h5>
          
          <div class="mb-3">
            <h6>æ¥½å˜åº¦</h6>
            <p class="starability-result" data-rating="<%= Math.round(course.stats.avg_ease) %>">
              Rated: <%= course.stats.avg_ease.toFixed(1) %> stars
            </p>
            <strong><%= course.stats.avg_ease.toFixed(1) %> / 5.0</strong>
          </div>
          
          <div class="mb-3">
            <h6>é¢ç™½ã•</h6>
            <p class="starability-result" data-rating="<%= Math.round(course.stats.avg_fun) %>">
              Rated: <%= course.stats.avg_fun.toFixed(1) %> stars
            </p>
            <strong><%= course.stats.avg_fun.toFixed(1) %> / 5.0</strong>
          </div>
          
          <hr>
          
          <p><strong>ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°:</strong> <%= course.stats.review_count %>ä»¶</p>
          <p class="mb-0"><strong>æˆæ¥­å†…å®¹æ›´æ–°æ—¥:</strong> <%= new Date(course.updated_at).toLocaleDateString('ja-JP') %></p>
        </div>
      </div>
      <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card mt-4">
        <div class="card-body">
          <h5>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿</h5>
          <!-- CSRF ãƒˆãƒ¼ã‚¯ãƒ³ -->
          <form method="POST" action="/courses/<%= course._id %>/reviews" id="reviewForm">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="user_uuid" id="userUuidInput">            
            <!-- æ¥½å˜åº¦ã®æ˜Ÿè©•ä¾¡ -->
            <div class="mb-3">
              <label class="form-label d-block">æ¥½å˜åº¦ <span class="text-danger">*</span></label>
              <fieldset class="starability-basic">
                <legend class="visually-hidden">æ¥½å˜åº¦ã‚’é¸æŠ</legend>
                <input type="radio" id="ease-no-rate" class="input-no-rate" name="ease_rating" value="" checked aria-label="æœªé¸æŠ" />
                <input type="radio" id="ease-rate1" name="ease_rating" value="1" required />
                <label for="ease-rate1" title="1 - éå¸¸ã«é›£ã—ã„">1 star</label>
                <input type="radio" id="ease-rate2" name="ease_rating" value="2" />
                <label for="ease-rate2" title="2 - ã‚„ã‚„é›£ã—ã„">2 stars</label>
                <input type="radio" id="ease-rate3" name="ease_rating" value="3" />
                <label for="ease-rate3" title="3 - æ™®é€š">3 stars</label>
                <input type="radio" id="ease-rate4" name="ease_rating" value="4" />
                <label for="ease-rate4" title="4 - ã‚„ã‚„æ¥½">4 stars</label>
                <input type="radio" id="ease-rate5" name="ease_rating" value="5" />
                <label for="ease-rate5" title="5 - éå¸¸ã«æ¥½">5 stars</label>
              </fieldset>
              <small class="text-muted">1 (é›£ã—ã„) ã€œ 5 (æ¥½)</small>
            </div>
            
            <!-- é¢ç™½ã•ã®æ˜Ÿè©•ä¾¡ -->
            <div class="mb-3">
              <label class="form-label d-block">é¢ç™½ã• <span class="text-danger">*</span></label>
              <fieldset class="starability-basic">
                <legend class="visually-hidden">é¢ç™½ã•ã‚’é¸æŠ</legend>
                <input type="radio" id="fun-no-rate" class="input-no-rate" name="fun_rating" value="" checked aria-label="æœªé¸æŠ" />
                <input type="radio" id="fun-rate1" name="fun_rating" value="1" required />
                <label for="fun-rate1" title="1 - å…¨ãé¢ç™½ããªã„">1 star</label>
                <input type="radio" id="fun-rate2" name="fun_rating" value="2" />
                <label for="fun-rate2" title="2 - ã‚ã¾ã‚Šé¢ç™½ããªã„">2 stars</label>
                <input type="radio" id="fun-rate3" name="fun_rating" value="3" />
                <label for="fun-rate3" title="3 - æ™®é€š">3 stars</label>
                <input type="radio" id="fun-rate4" name="fun_rating" value="4" />
                <label for="fun-rate4" title="4 - ã‚„ã‚„é¢ç™½ã„">4 stars</label>
                <input type="radio" id="fun-rate5" name="fun_rating" value="5" />
                <label for="fun-rate5" title="5 - éå¸¸ã«é¢ç™½ã„">5 stars</label>
              </fieldset>
              <small class="text-muted">1 (ã¤ã¾ã‚‰ãªã„) ã€œ 5 (é¢ç™½ã„)</small>
            </div>
            
            <div class="mb-3">
              <label class="form-label">ã‚³ãƒ¡ãƒ³ãƒˆ</label>
              <textarea name="comment" class="form-control" rows="4" placeholder="æˆæ¥­ã®æ„Ÿæƒ³ã‚„å¾Œè¼©ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãªã©ã‚’è‡ªç”±ã«è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary">æŠ•ç¨¿</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/main.js"></script>
<script>
// Bootstrap ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

// ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
document.getElementById('reviewForm').addEventListener('submit', function (e) {
  const easeRating = document.querySelector('input[name="ease_rating"]:checked');
  const funRating = document.querySelector('input[name="fun_rating"]:checked');

  // æœªé¸æŠï¼ˆvalue=""ï¼‰ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
  if (!easeRating || easeRating.value === '') {
    e.preventDefault();
    alert('æ¥½å˜åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return false;
  }

  if (!funRating || funRating.value === '') {
    e.preventDefault();
    alert('é¢ç™½ã•ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return false;
  }
});

// ğŸ”‘ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’JSå¤‰æ•°ã«æ ¼ç´ (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®<script>ãƒ–ãƒ­ãƒƒã‚¯ã®å…ˆé ­ã«è¿½åŠ )
const CSRF_TOKEN = "<%= csrfToken %>";
// ğŸ’¡ã€è¿½åŠ ã€‘localStorageã‹ã‚‰user_uuidã‚’å–å¾—ã—ã€éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
const userUuidFromStorage = localStorage.getItem('user_uuid');
const userUuidInput = document.getElementById('userUuidInput');
if (userUuidInput && userUuidFromStorage) {
  userUuidInput.value = userUuidFromStorage;
}

// ===================================
// ç®¡ç†è€…æ©Ÿèƒ½: ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰Šé™¤
// ===================================
document.querySelectorAll('.delete-review-btn').forEach(btn => {
  btn.addEventListener('click', async function () {
    const reviewId = this.getAttribute('data-review-id');

    if (!confirm('ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“')) {
      return;
    }

    try {
      const response = await fetch(`/admin/reviews/${reviewId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': CSRF_TOKEN
        }
      });

      const data = await response.json();

      if (data.success) {
        // æˆåŠŸæ™‚ã¯å³åº§ã«ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼‰
        location.reload();
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
      }
    } catch (err) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  });
});

// ===================================
// ç®¡ç†è€…æ©Ÿèƒ½: æˆæ¥­å‰Šé™¤
// ===================================
const deleteCourseBtn = document.getElementById('deleteCourseBtn');
if (deleteCourseBtn) {
  deleteCourseBtn.addEventListener('click', async function () {
    const courseId = this.getAttribute('data-course-id');

    if (!confirm('ã“ã®æˆæ¥­ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nâ€»é–¢é€£ã™ã‚‹ã™ã¹ã¦ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“')) {
      return;
    }
    
    try {
      const response = await fetch(`/admin/courses/${courseId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          // ğŸš¨ ä¿®æ­£ç‚¹: CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ 
          'X-CSRF-Token': CSRF_TOKEN
        }
      });

      const data = await response.json();

      if (data.success) {
        alert('æˆæ¥­ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        // ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        window.location.href = '/';
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
      }
    } catch (err) {
      console.error(err);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  });
}
</script>
</body>
</html>